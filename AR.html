<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR </title>
    <!-- A-Frame สำหรับสร้างและแสดงผล AR -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <!-- AR.js สำหรับใช้งาน AR บน A-Frame ด้วย GPS -->
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
</head>
<body style="margin: 0; overflow: hidden;">
    <!-- เริ่มต้นฉากของ A-Frame -->
    <a-scene
        vr-mode-ui="enabled: false"
        renderer="logarithmicDepthBuffer: true;"
        embedded
        arjs="sourceType: webcam; debugUIEnabled: false;">
        
        <!-- กล้อง AR ที่ใช้ตำแหน่ง GPS -->
        <a-camera gps-camera="gpsMinDistance: 10;"></a-camera>

        <!-- สถานที่จะแสดงที่นี่ -->
        <a-entity id="places-icons"></a-entity>

    </a-scene>

    <script>
        // ฟังก์ชันดึงข้อมูลสถานที่ (คุณสามารถเพิ่มสถานที่ตามข้อมูลที่คุณมี)
        const places = [
            {
                name: "Cafe",
                latitude: 16.75216255070639, 
                longitude: 100.19692711250192,
                type: "cafe",  // ประเภทของสถานที่
                icon: "image/cafe.png"  // ไอคอนสำหรับสถานที่
            },
            {
                name: "Restaurant",
                latitude: 16.751980533811853, 
                longitude:100.19671114681755,
                type: "food",
                icon: "image/food.png"
            },
            {
                name: "Gym",
                latitude: 16.751814013338517, 
                longitude:100.19692565632594,
                type: "gym",
                icon: "image/muscle.png"
            },
            {
                name: "Hospital",
                latitude:16.751840826512645,
                longitude:  100.19705314160306,
                type: "hospital",
                icon: "image/hospital.png"
            },
            // เพิ่มสถานที่อื่น ๆ ตามข้อมูลที่คุณมี
        ];

        // คำนวณระยะทางระหว่างผู้ใช้กับสถานที่ (ใช้สูตร Haversine Formula)
        function calculateDistance(userCoords, placeCoords) {
            const toRadian = angle => (Math.PI / 180) * angle;
            const distance = (a, b) => (Math.PI / 180) * (a - b);
            const RADIUS_OF_EARTH_IN_KM = 6371;

            const dLat = distance(placeCoords.lat, userCoords.lat);
            const dLon = distance(placeCoords.lng, userCoords.lng);

            const lat1 = toRadian(userCoords.lat);
            const lat2 = toRadian(placeCoords.lat);

            const a =
                Math.pow(Math.sin(dLat / 2), 2) +
                Math.pow(Math.sin(dLon / 2), 2) *
                Math.cos(lat1) *
                Math.cos(lat2);

            const c = 2 * Math.asin(Math.sqrt(a));
            const distanceInKm = RADIUS_OF_EARTH_IN_KM * c;

            return distanceInKm.toFixed(2);
        }

        // ฟังก์ชันสำหรับแสดงไอคอนของสถานที่ใน AR
        window.onload = () => {
            renderPlaces(places);
        };

        function renderPlaces(places) {
            const scene = document.querySelector('a-scene');  // เลือก scene ที่จะใส่ไอคอน

            navigator.geolocation.getCurrentPosition((position) => {
                const userCoords = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };

                places.forEach(place => {
                    const latitude = place.latitude;
                    const longitude = place.longitude;
                    const distance = calculateDistance(userCoords, { lat: latitude, lng: longitude });

                    // สร้าง element หลักที่จะใส่ไอคอนและข้อความ
                    const placeEntity = document.createElement('a-entity');
                    placeEntity.setAttribute('gps-entity-place', `latitude: ${latitude}; longitude: ${longitude}`);
                    placeEntity.setAttribute('look-at', '[gps-camera]'); // ให้ entity ทั้งหมดหันเข้าหากล้อง

                    // ไอคอนสถานที่
                    const icon = document.createElement('a-image');
                    icon.setAttribute('src', place.icon);
                    icon.setAttribute('scale', '2 2'); // ปรับขนาดของไอคอน
                    icon.setAttribute('position', '0 0 -5'); // ปรับตำแหน่งให้ห่างกล้องน้อยลง
                    // icon.setAttribute('look-at', '[gps-camera]'); // นำออกเพราะใช้ใน entity หลักแล้ว

                    // ข้อความชื่อสถานที่และระยะทาง
                    const textLabel = document.createElement('a-text');
                    textLabel.setAttribute('value', `${place.name} (${distance} km)`);
                    textLabel.setAttribute('align', 'center');
                    textLabel.setAttribute('position', '0 -1.5 -5');  // ปรับตำแหน่งให้อยู่ใต้ไอคอน
                    textLabel.setAttribute('scale', '5 5'); // ปรับขนาดของข้อความ
                    // textLabel.setAttribute('look-at', '[gps-camera]'); // นำออกเพราะใช้ใน entity หลักแล้ว

                    // เพิ่มไอคอนและข้อความเข้าใน entity หลัก
                    placeEntity.appendChild(icon);
                    placeEntity.appendChild(textLabel);

                    // เพิ่ม entity ของสถานที่ใน scene
                    scene.appendChild(placeEntity);  
                });
            }, (err) => {
                console.error("ตำแหน่งไม่สามารถใช้งานได้: ", err);
                alert("ไม่สามารถเข้าถึงตำแหน่งของคุณได้ กรุณาเปิดใช้งาน GPS");
            });
        }
    </script>
</body>
</html>
